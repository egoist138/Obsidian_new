
 
 Установка и настройка PgBouncer для PostgreSQL

Пулер может находиться на том же хосте, где работает PostgreSQL, или на отдельном. Мы будем все делать на одном хосте с базой данных. Установим PgBouncer из стандартных репозиториев Ubuntu:

      `sudo apt-get -y install pgbouncer`

После завершения установки отредактируем файл **/etc/pgbouncer/pgbouncer.ini**. Укажем, на каком хосту и порту PgBouncer должен искать запущенный сервер PostgreSQL. Для этого в раздел **[databases]** добавим:

      `* = host=localhost port=5432`

Затем изменим параметр **listen_addr**. Тут нужно указать IP-адрес, на котором будет доступен PgBouncer. Мы укажем **listen_addr = ***, чтобы PgBouncer был доступен на всех IP-адрес виртуальной машины (внутренних и внешних).

Далее поменяем параметр **auth_type**. По умолчанию PgBouncer настроен на тип авторизации **trust**, использовать которую небезопасно и рекомендуется лишь в ознакомительных целях. Мы сразу заменим этот параметр на **md5**.

Также отредактируем параметр **max_client_conn**, который отвечает за максимальное количество одновременных соединений. Установим его значение равным 500, это пригодится нам при тестировании.

Обратите внимание на значение параметра **listen_port** (в него не нужно вносить изменение). Тут указывается порт, на котором будет доступен PgBouncer. Стандартный порт для PostgreSQL — 5432, а для PgBouncer — 6432. При этом подключаться к БД можно будет по обоим портам, но при необходимости стандартный порт можно закрыть.

Итоговый файл конфигурации выглядит так:

      `[databases]  * = host=localhost port=5432  [pgbouncer]  logfile = /var/log/postgresql/pgbouncer.log pidfile = /var/run/postgresql/pgbouncer.pid  listen_addr = * listen_port = 6432  unix_socket_dir = /var/run/postgresql  auth_type = md5 auth_file = /etc/pgbouncer/userlist.txt  max_client_conn = 500`

Далее нужно создать список пользователей, у которых будет доступ к PgBouncer. Пользователи уже должны существовать в Postgres. Подробнее про создание и управление пользователями смотрите [отдельную инструкцию](https://selectel.ru/blog/tutorials/how-to-create-user-postgre/).

Создадим файл **/etc/pgbouncer/userlist.txt** и запишем в него строки формата:

      `“<ИМЯ_ПОЛЬЗОВАТЕЛЯ>” “<ПАРОЛЬ>”`

Но хранить пароли в открытом виде небезопасно, поэтому вместо пароля лучше записать его хеш. Выполним команду:

      `echo -n '<ПАРОЛЬ>' | md5sum`

Она выдаст хеш пароля, его и будем использовать вместе с префиксом **md5** вначале:

      `“<ИМЯ_ПОЛЬЗОВАТЕЛЯ>” “md5<ПАРОЛЬ>”`

Настройка PgBouncer завершена, запустим его:

      `systemctl enable --now pgbouncer`