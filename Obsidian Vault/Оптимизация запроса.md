1. https://explain.tensor.ru/archive/explain/27e242cf7cf42e5a8bd3d6c9c49dda24:0:2025-12-02
2. https://explain.tensor.ru/archive/explain/31519ee5c061a97386f5fbe60647e9c2:0:2025-12-02
3. https://explain.tensor.ru/archive/explain/64fbd0daaa977d472e015c6fb8c5baad:0:2025-12-02
4. https://explain.tensor.ru/archive/explain/9e9050d7d1fa026d3a27de744663b3d5:0:2025-12-02
5. https://explain.tensor.ru/archive/explain/901dfaa4d22387a3e4f7ac5ac2d82620:0:2025-12-02
6. https://explain.tensor.ru/archive/explain/a729d196d3a4a79509d8a162f0f29600:0:2025-12-02
7. https://explain.tensor.ru/archive/explain/8fad04c1048a7943a4a17991f35b9e0e:0:2025-12-02


## Что удалось ускорить

### 1. Запросы №1 и №2

Эти два запроса тормозили из-за полного сканирования таблицы `profile_calculator_profiledatahypertable`.

**Было:**

- Запрос 1: [https://explain.tensor.ru/archive/explain/27e242cf7cf42e5a8bd3d6c9c49dda24:0:2025-12-02](https://explain.tensor.ru/archive/explain/27e242cf7cf42e5a8bd3d6c9c49dda24:0:2025-12-02)
    
- Запрос 2: [https://explain.tensor.ru/archive/explain/31519ee5c061a97386f5fbe60647e9c2:0:2025-12-02](https://explain.tensor.ru/archive/explain/31519ee5c061a97386f5fbe60647e9c2:0:2025-12-02)
    

Создал индекс, который закрывает оба запроса одним махом:

```sql
CREATE INDEX idx_profiledata_core 
ON profile_calculator_profiledatahypertable 
    (created_date, date, version_id, well_id)
    INCLUDE (profile_type_id, value);
```


**Стало:**

- Запрос 1: [https://explain.tensor.ru/archive/explain/4475a1472ca6f1161a5c83e7c5c5d683:0:2025-12-18](https://explain.tensor.ru/archive/explain/4475a1472ca6f1161a5c83e7c5c5d683:0:2025-12-18)
    
- Запрос 2: [https://explain.tensor.ru/archive/explain/29d5005df2a111119fe48e52d16c7dec:0:2025-12-18](https://explain.tensor.ru/archive/explain/29d5005df2a111119fe48e52d16c7dec:0:2025-12-18)
    

Индекс покрывающий — теперь Postgres вообще не лезет в таблицу, все данные берет из индекса.

---

### 2. Запросы №4 и №7

Тут проблема была в кривых условиях. В запросах были конструкции типа `WHERE id IN (60, 61, 60, 61, 60, 61, ...)` — одни и те же значения повторялись по 10-20 раз.

**Было:**

- Запрос 4: [https://explain.tensor.ru/archive/explain/9e9050d7d1fa026d3a27de744663b3d5:0:2025-12-02](https://explain.tensor.ru/archive/explain/9e9050d7d1fa026d3a27de744663b3d5:0:2025-12-02)
    
- Запрос 7: [https://explain.tensor.ru/archive/explain/8fad04c1048a7943a4a17991f35b9e0e:0:2025-12-02](https://explain.tensor.ru/archive/explain/8fad04c1048a7943a4a17991f35b9e0e:0:2025-12-02)
    

Почистил дубли в `IN`-списках. Оказалось, что из-за этого:

1. Буферный кеш забивался одинаковыми данными
2. Планировщик тратил время на обработку дублей
3. Лишние логические чтения
    

**Стало:**

- Запрос 4: [https://explain.tensor.ru/archive/explain/d53a2da8c80d81691d2ede369238d339:0:2025-12-11](https://explain.tensor.ru/archive/explain/d53a2da8c80d81691d2ede369238d339:0:2025-12-11)
    
- Запрос 7: [https://explain.tensor.ru/archive/explain/34e1427226b23ecf32ef31b9cd845476:0:2025-12-11](https://explain.tensor.ru/archive/explain/34e1427226b23ecf32ef31b9cd845476:0:2025-12-11)
    

Упало время выполнения, меньше нагрузка на shared buffers.

---

## Что по остальным запросам

Остальные запросы пока без изменений, но у них свои проблемы:

3. [https://explain.tensor.ru/archive/explain/64fbd0daaa977d472e015c6fb8c5baad:0:2025-12-02](https://explain.tensor.ru/archive/explain/64fbd0daaa977d472e015c6fb8c5baad:0:2025-12-02) — тут сложные джоины
    
4. [https://explain.tensor.ru/archive/explain/901dfaa4d22387a3e4f7ac5ac2d82620:0:2025-12-02](https://explain.tensor.ru/archive/explain/901dfaa4d22387a3e4f7ac5ac2d82620:0:2025-12-02) — проблемы с селективностью
    
5. [https://explain.tensor.ru/archive/explain/a729d196d3a4a79509d8a162f0f29600:0:2025-12-02](https://explain.tensor.ru/archive/explain/a729d196d3a4a79509d8a162f0f29600:0:2025-12-02) — тоже нужно смотреть
    

По п.3.5.6 из задачи — еще не делал, в работе.

---

## Итог

1. **Индекс на hypertable** — ускорил 1 и 2 запросы в разы
    
2. **Чистка дублей в IN** — сняла лишнюю нагрузку с кеша для 4 и 7 запросов
    
3. **Пока не трогал** 3, 5, 6 — нужно отдельно разбираться